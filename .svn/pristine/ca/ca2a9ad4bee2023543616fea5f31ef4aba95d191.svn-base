/**
 * Created by mouli on 25/01/15.
 */
angular.module('ezeidApp').controller('DocumentController', function($http, $rootScope, $scope, $timeout, Notification, $filter,$q) {

    $scope.fileSeclected = undefined;

    $scope.Token = $rootScope._userInfo.Token;

    var original_form = {
        RefNo:'',
        RefExpiryDate:'',
        RefType:1,
        RefDoc:undefined,
        RefFileName:undefined
    };

    $scope.form = {
        RefNo:'',
        RefExpiryDate:'',
        RefType:1,
        RefDoc:undefined,
        RefFileName:undefined
    };

    $scope.uploadFile = function (files) {
        for (var i = 0; i < files.length; i++) {
            var $file = files[i];
            var formData = new FormData();
            formData.append('file', $file);
            formData.append('RefType', $scope.OptionSelected);
            formData.append('TokenNo', $rootScope._userInfo.Token);
            console.log(formData);
            debugger;

            $http({ method: 'POST', url: '/ewTUploadDoc/', data: formData,
                headers: { 'Content-Type': undefined }, transformRequest: angular.identity })
                .success(function (data, status, headers, config) {
                    console.log("uploaded");
                }).
                error(function(data, status, headers, config) {
                    console.log("upload ERROR");
                });
        }
    };

    var fileToDataURL = function (file) {
        var deferred = $q.defer();
        var reader = new FileReader();
        reader.onload = function (e) {
            deferred.resolve(e.target.result);
        };
        reader.readAsDataURL(file);
        return deferred.promise;
    };

    $scope.OptionSelected = 1;

    getDocumentDetails($scope.OptionSelected);

    $scope.OnOptionSelected = function(option){
        $scope.OptionSelected = option;

        getDocumentDetails(option);
    };

    function getDocumentDetails(option){
        $scope.form = original_form;

        if($rootScope._userInfo && $rootScope._userInfo.Token){
            $http({ method: 'get', url: '/ewtGetDoc?TokenNo=' + $rootScope._userInfo.Token + '&&Type='+ option }).success(function (data) {
                if(data && data.length > 0){
                    if($scope.OptionSelected==1){
                        console.log("ID Card Downloaded");
                        $scope.form.RefNo = data[0].IDNo;
                        $scope.form.RefExpiryDate = new Date(data[0].IDExpiryDate);
                        $scope.form.RefDoc = data[0].IDDoc;
                        $scope.form.RefFileName = data[0].IDDocFilename;
                    }else if($scope.OptionSelected==2){
                        console.log("PP Downloaded");
                        $scope.form.RefNo = data[0].PPNo;
                        $scope.form.RefExpiryDate = new Date(data[0].PPExpiryDate);
                        $scope.form.RefDoc = data[0].PPDoc;
                        $scope.form.RefFileName = data[0].PPDocFilename;
                    }else if($scope.OptionSelected==3){
                        console.log("DL Downloaded");
                        $scope.form.RefNo = data[0].DLNO;
                        $scope.form.RefExpiryDate = new Date(data[0].DLExpiryDate);
                        $scope.form.RefDoc = data[0].DLDoc;
                        $scope.form.RefFileName = data[0].DLDocFilename;
                    }else if($scope.OptionSelected==4){
                        console.log("D1 Downloaded");
                        $scope.form.RefNo = data[0].D1NO;
                        $scope.form.RefExpiryDate = new Date(data[0].D1ExpiryDate);
                        $scope.form.RefDoc = data[0].D1Doc;
                        $scope.form.RefFileName = data[0].D1DocFilename;
                    }else if($scope.OptionSelected==5){
                        console.log("D2 Downloaded");
                        $scope.form.RefNo = data[0].D2No;
                        $scope.form.RefExpiryDate = new Date(data[0].D2ExpiryDate);
                        $scope.form.RefDoc = data[0].D2Doc;
                        $scope.form.RefFileName = data[0].D2DocFilename;
                    }
                }
            }).error( function(error){
                console.log(error);
            });
        }
    }

    $scope.OnSaveDocument = function(){
        $scope.form.TokenNo = $rootScope._userInfo.Token;
        $scope.form.RefType = $scope.OptionSelected;
        $http({
            method: "POST",
            url: '/ewtSaveDoc',
            data: JSON.stringify($scope.form),
            headers: { 'Content-Type': 'application/json' }
        }).success(function (data) {
            console.log(data);
            if(data.IsSuccessfull) {
            }else{
            }
        });
    }
});