
/****************** Map asynchronous loading functions start *************************************/

//function initialize() {
//  var mapOptions = {
//    zoom: 8,
//    center: new google.maps.LatLng(-34.397, 150.644)
//  };
//
//  var map = new google.maps.Map(document.getElementById('map-canvas'),
//      mapOptions);
//  console.log('I am called 2');
//}

//function loadScript() {
//  var script = document.createElement('script');
//  script.type = 'text/javascript';
//  script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp' +
//      '&signed_in=true&callback=initialize';
//  document.body.appendChild(script);
//    console.log('I am called 3');
//}

/***************** Map asynchronous loading functions end ******************/

(function () {
    var ezeid = angular.module('ezeidApp',
        ['ngHeader','ngRoute', 'ngFooter', 'ui-notification', 'kendo.directives','imageupload']);

    ezeid.config(['$routeProvider',function($routeProvider){
        $routeProvider.when('/index',{templateUrl: 'html/index.html'})
            .when('/home',{templateUrl: 'html/home.html'})
            .when('/messages',{templateUrl: 'html/messages.html'})
            .when('/acchist',{templateUrl: 'html/accesshistory.html'})
            .when('/editprofile',{templateUrl: 'html/signupwiz.html'})
            .when('/addloc',{templateUrl: 'html/addlocations.html'})
            .when('/addnewloc',{templateUrl: 'html/addnewlocations.html'})
            .when('/attachcv',{templateUrl: 'html/attachcv.html'})
            .when('/busslist',{templateUrl: 'html/businesslist.html'})
            .when('/documents',{templateUrl: 'html/documents.html'})
            .when('/terms',{templateUrl: 'html/terms.html'})
            .when('/help',{templateUrl: 'html/help.html'})
            .when('/legal',{templateUrl: 'html/legal.html'})
            .otherwise({ templateUrl: 'html/home.html' });
    }]);

    var GURL = '/'; //http://10.0.100.103:8084/';

    var MsgDelay = 2000;

    // define controller for wizard
    ezeid.controller('SampleWizardController', function($scope, $q, $timeout) {

            $scope.user = {};

            $scope.saveState = function() {
                var deferred = $q.defer();

                $timeout(function() {
                    deferred.resolve();
                }, 5000);

                return deferred.promise;
            };

            $scope.completeWizard = function() {
                alert('Completed!');
            }
        });

    //Global Controller
    ezeid.controller('HomeController', function ($rootScope, $http,$scope) {
           $rootScope.CLoc = {
            CLat: 12.295810,
            CLong: 76.639381
        };

        if ($rootScope._userInfo) {

        }
        else {
            if (typeof (Storage) !== "undefined") {
                var encrypted = sessionStorage.getItem("_token");
                if (encrypted) {
                    var decrypted = CryptoJS.AES.decrypt(encrypted, "EZEID");
                    var Jsonstring = decrypted.toString(CryptoJS.enc.Utf8);
                    if (Jsonstring) {
                        $rootScope._userInfo = JSON.parse(Jsonstring);
                    }
                }
                else {
                    $rootScope._userInfo = {
                        IsAuthenticate: false,
                        Token: '',
                        FirstName: '',
                        Type: '',
                        Icon: ''
                    };
                }
            } else {
                // Sorry! No Web Storage support..
                $rootScope._userInfo = {
                    IsAuthenticate: false,
                    Token: '',
                    FirstName: '',
                    Type: '',
                    Icon: ''
                };
                alert('Sorry..! Browser does not support');
                window.location.href = "#/";
            }
        }

        /**
         * Opens Help Popup when help link is clicked
         */
        $scope.openHelpPopup =function(){
            $('#Help_popup').css({'position':'fixed'});
            $('#Help_popup > div').css({'margin-top':'0%'});
            $('#Help_popup').slideDown();
        };
        $scope.closeHelpPopup =function(){
            $('#Help_popup').slideUp();
        }
    });

    // Search Controller
    ezeid.controller('SearchController', function ($http, $rootScope, $scope, $compile, $timeout, Notification, $filter, $location, $window) {

//        $interval(function() {
//            var pos = 
//            reSizeHomeMap();
//            
//        },2000);
//
//        function reSizeHomeMap() {
//            google.maps.event.trigger(map, "resize");
//            
//            map.setCenter(new google.maps.LatLng($rootScope.CLoc.CLat, $rootScope.CLoc.CLong));
//         }
//
//        $scope.selectedTab = "";
//        if ($location.search()['ID'] != undefined) {
//         }

        
        var map;
        var marker;
        var markers = [];
        
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();
        var myinfowindow = new google.maps.InfoWindow({
            content: ''
        });
        var service;
        var today = $filter('date')(new Date(), 'MM/dd/yyyy HH:mm:ss');

        function getQueryStringValue(key) {
            return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
        }

        var SearchSec = this;

        SearchSec.IsShowForm = false;

        SearchSec.categories = [];
        SearchSec.proximities = [];
        SearchSec.mInfo = {};
        SearchSec.Placeholder = 'Type EZEID';
        SearchSec.mInfo.InfoTab = true;
        $scope.showInfoTab = false;

        SearchSec.Criteria = {
            Token: '',
            SearchType: '1',
            Keywords: '',
            SCategory: 0,
            Proximity: 1600,
            Latitude: $rootScope.CLoc.CLat,
            Longitude: $rootScope.CLoc.CLong
        };

        function initialize () {
            //// Create the search box and link it to the UI element.
            
            directionsDisplay = new google.maps.DirectionsRenderer();
            var initialLocation;
            var currentLoc = new google.maps.LatLng(12.295810, 76.639381);
            map = new google.maps.Map(document.getElementById('map-canvasH'), {
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                Zoom: 15
            });
            $scope.gMap = map;
            var ClocBtn = (document.getElementById('mapClocH'));
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(ClocBtn)
            var input = /** @type {HTMLInputElement} */(document.getElementById('txtSearch'));
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

  var searchBox = new google.maps.places.SearchBox(
    /** @type {HTMLInputElement} */(input));
            //directionsDisplay.setMap(map);
            // Try W3C Geolocation (Preferred)
            if (navigator.geolocation) {
                browserSupportFlag = true;
                navigator.geolocation.getCurrentPosition(FindCurrentLocation, function () {
                    handleNoGeolocation();
                });
            }
                // Browser doesn't support Geolocation
            else {
                handleNoGeolocation();
            }

            function handleNoGeolocation() {
                initialLocation = currentLoc;
                map.setCenter(initialLocation);
                PlaceCurrentLocationMarker(initialLocation);
                //PlaceMarker(initialLocation);
            }

            

            // Listen for the event fired when the user selects an item from the
            // pick list. Retrieve the matching places for that item.
            google.maps.event.addListener(searchBox, 'places_changed', function () {
                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }
                for (var i = 0, marker; marker = markers[i]; i++) {
                    marker.setMap(null);
                }

                // For each place, get the icon, place name, and location.
                markers = [];
                var bounds = new google.maps.LatLngBounds();
                if (places.length > 0) {
                    var place = places[0];
                    $rootScope.CLoc.CLat = place.geometry.location.k;
                    $rootScope.CLoc.CLong = place.geometry.location.D;
                    var loc = new google.maps.LatLng($rootScope.CLoc.CLat, $rootScope.CLoc.CLong);
                    PlaceCurrentLocationMarker(loc);
                }
            });

            // Bias the SearchBox results towards places that are within the bounds of the
            // current map's viewport.
            google.maps.event.addListener(map, 'bounds_changed', function () {
                var bounds = map.getBounds();
                searchBox.setBounds(bounds);
            });

            google.maps.event.addListenerOnce(map, 'idle', function () {

                if(SearchSec.IsSearchPending){
                    SearchSec.getSearch();
                }
            });
            $(window).resize(function() {
                google.maps.event.trigger(map, "resize");
            });
        }
        google.maps.event.addDomListener(window, 'load', initialize);

        function PlaceCurrentLocationMarker(location) {
            if (marker != undefined) {
                marker.setMap(null);
            }
            map.setCenter(location);
            marker = new google.maps.Marker({
                position: location,
                title: "Current Location",
                draggable: true,
                map: map,
                icon: 'images/you_are_here.png'
            });
            google.maps.event.addListener(marker, 'dragend', function (e) {
                $rootScope.CLoc.CLat = marker.getPosition().k;
                $rootScope.CLoc.CLong = marker.getPosition().D;
                //getReverseGeocodingData(marker.getPosition().k, marker.getPosition().D);
//                myinfowindow.setContent('<h6>You are here</h6>');
                //myinfowindow.open(map, marker);
            });
        }
        this.getMyLocation = function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(FindCurrentLocation);
            }
        };
        function FindCurrentLocation(position) {
            initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            $rootScope.CLoc = {
                CLat: position.coords.latitude,
                CLong: position.coords.longitude
            };
            PlaceCurrentLocationMarker(initialLocation);
        }
        function PlaceMarker(positions) {
            directionsDisplay.setMap(null);
            for (var i = 0, Cmarker; Cmarker = markers[i]; i++) {
                Cmarker.setMap(null);
            }
            markers = [];


            if (positions != null) {
                for (var i = 0; i < positions.length; i++) {
                    var _item = positions[i];
                    var mapIcon;
//                    mapIcon = _item.Icon == "" ? 'images/Indi_user.png' : _item.Icon;

                      mapIcon = '/images/Indi_user.png';

                    var pos = new google.maps.LatLng(_item.Latitude, _item.Longitude);
                    var marker = new google.maps.Marker({
                        position: pos,
                        map: map,
                        icon: mapIcon,
                        title: _item.FirstName + ' ' + _item.LastName
                    });
//                    map.setCenter(pos);
                    var currentPos = google.maps.LatLng($rootScope.CLoc.CLat,$rootScope.CLoc.CLong);
                    map.setCenter(currentPos);
                    markers.push(marker);
                    google.maps.event.addListener(marker, 'click', (function (_item) {
                        return function () {
                            var sen = this;
                            $http({ method: 'get', url: GURL + 'ewtGetSearchInformation?Token=' + $rootScope._userInfo.Token + '&TID=' + _item.TID }).success(function (data) {
                                if (data != 'null') {
                                    $timeout(function () {
                                        SearchSec.mInfo = data[0];
                                        
                                       // $('#Maping_popup').slideDown();
                                        //$scope.selectedTab = "info";
                                        $scope.showInfoTab = true;
                                        $scope.selectTab('info');
                                        //var content = document.getElementById('Maping_popup').innerHTML;
                                        //var compiled = $compile(content)($scope);
                                        //myinfowindow.setContent(compiled[0]);
                                        //myinfowindow.open(map, sen);
                                    });
                                }
                                else {
                                    Notification.error({ message: 'No Results found..!', delay: MsgDelay });
                                }
                            });
                        }

                         //   google.maps.event.trigger(map, "resize");

                    })(_item));
                }
            }
        }

       /* $(window).resize(function() {
         google.maps.event.trigger(map, "resize");
         });*/
        $http({ method: 'get', url: GURL + 'ewmGetCategory?LangID=1' }).success(function (data) {
            var _obj = { CategoryID: 0, CategoryTitle: '--Any--' };
            data.splice(0, 0, _obj);
            SearchSec.categories = data;
        });

        $http({ method: 'get', url: GURL + 'ewmGetProxmity?LangID=1' }).success(function (data) {
            //var _obj = { Title: '--Proximity--', MetersValue: 0 };
            //data.splice(0, 0, _obj);
            SearchSec.proximities = data;
        });

//        SearchSec.OpenStatuses = [{ id: 0, label: "Any" }, { id: 1, label: "Open" }, { id: 2, label: "Closed" }];
        SearchSec.OpenStatuses = [ { id: 1, label: "Open" }, { id: 2, label: "Closed" }];

        SearchSec.isEZEIDselected = function (value) {
            if (SearchSec.Criteria.SearchType == 1)
                SearchSec.Placeholder = 'Type EZEID';
            else
                SearchSec.Placeholder = 'Type Keywords';
            return value === SearchSec.Criteria.SearchType;
        };

        SearchSec.isIndividualUser = function (value) {
            return value === parseInt(SearchSec.mInfo.IDTypeID);
        };

        SearchSec.getSearch = function () {

            SearchSec.IsShowForm = false;
            SearchSec.Criteria.ParkingStatus = SearchSec.Criteria.ParkingStatus == 1 ? '1,2' :0;
            SearchSec.Criteria.OpenStatus = (SearchSec.Criteria.OpenStatus.id == 1) ? 0 : SearchSec.Criteria.OpenStatus ;

            if ($rootScope._userInfo.IsAuthenticate == true) {
                SearchSec.Criteria.Latitude = $rootScope.CLoc.CLat;
                SearchSec.Criteria.Longitude = $rootScope.CLoc.CLong;
                SearchSec.Criteria.Token = $rootScope._userInfo.Token;
                $http({ method: 'post', url: GURL + 'ewSearchByKeywords', data: SearchSec.Criteria }).success(function (data) {
                    if (data != 'null' && data.length>0) {
                        var _item = data[0];

                         if(data[0].Filename)
                        {
                            SearchSec.downloadData = data[0];
                           // $('#download_popup').slideDown();
                            SearchSec.IsShowForm = true;
                            //$scope.showInfoTab = true;
                        }
                        else
                        {
                            // if(SearchSec.Criteria.Type="1" ){

                            $http({ method: 'get', url: GURL + 'ewtGetSearchInformation?Token=' + $rootScope._userInfo.Token + '&TID=' + _item.TID }).success(function (data) {
                                if (data != 'null') {

                                   if(data.length == 1 && SearchSec.Criteria.SearchType == 1)
                                   {
                                       $scope.showInfoTab = true;
//                                       $scope.selectedTab = "info";
//                                       
                                       $scope.selectTab('info');
                                       // google.maps.event.trigger(map, "resize");
                                   }
                                   else
                                   {
//                                       $scope.selectedTab = "maps";
                                        $scope.selectTab('map');
                                   }
                                    $timeout(function () {
                                        SearchSec.mInfo = data[0];
                                        $scope.$apply();
                                       //    $('#Maping_popup').slideDown();
                                    });
                                } else {
                                    Notification.error({ message: 'No Results found..!', delay: MsgDelay });
                                }
                            });
                            PlaceMarker(data);
                        }
                       // PlaceMarker(data);//older one
                    }
                    else {
                        PlaceMarker(null);
                        Notification.error({ message: 'No Results found..!', delay: MsgDelay });
                    }
                });
            }
            else {
                //Redirect to Login page
                $('#SignIn_popup').slideDown();
            }
        };

        
        /**
         * Selects a particular tab
         */
                $scope.infoClass = "";
                $scope.mapClass = "";
                $scope.adClass = "level-1";
                $scope.selectTab = function (tabName){
                    if(tabName == 'info')
                    {
                        $scope.infoClass = "level-1";
                        $scope.mapClass = "";
                        $scope.adClass = "";
                    }
                    
                    if(tabName == 'ad')
                    {
                         $scope.infoClass = "";
                        $scope.mapClass = "";
                        $scope.adClass = "level-1";

                    }
                    
                    if(tabName == 'map')
                    {
                        $scope.infoClass = "";
                        $scope.mapClass = "level-1";
                        $scope.adClass = "";
                    }
                    
                };
        function getMapSearchResults(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                if (results.length > 0) {
                    var place = results[0];
                    $rootScope.CLoc.CLat = place.geometry.location.k;
                    $rootScope.CLoc.CLong = place.geometry.location.D;
                    var loc = new google.maps.LatLng($rootScope.CLoc.CLat, $rootScope.CLoc.CLong);
                    PlaceCurrentLocationMarker(loc);
                }
            }
            else {
                Notification.error({ message: 'No Results found..!', delay: MsgDelay });
            }
        }

        SearchSec.getdirections = function (data) {
           // $('#Maping_popup').slideUp();

//            $scope.selectedTab = "map";
            $scope.selectTab('map');
            var start = new google.maps.LatLng($rootScope.CLoc.CLat, $rootScope.CLoc.CLong);
            var end = new google.maps.LatLng(data.Latitude, data.Longitude);
            directionsDisplay.setMap(map);
            var request = {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING
            };
            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                }
            });
        };

        //open Sales Enquiry form
        SearchSec.openSalesEnquiryForm = function () {
            $('#SalesEnquiryRequest_popup').slideDown();
        };

        SearchSec.sendSalesEnquiry = function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                $http({ method: 'post', url: GURL + 'ewtSaveMessage', data: { TokenNo: $rootScope._userInfo.Token, ToMasterID: SearchSec.mInfo.TID, MessageType: 1, Message: SearchSec.salesMessage, TaskDateTime: today } }).success(function (data) {
                    if (data.IsSuccessfull) {
                        $('#SalesEnquiryRequest_popup').slideUp();
                        SearchSec.salesMessage = "";
                        Notification.success({ message: 'Message send success', delay: MsgDelay });
                    }
                    else {
                        Notification.error({ message: 'Sorry..! Message not send ', delay: MsgDelay });
                    }
                });
            }
            else {
                //Redirect to Login page
                $('#SignIn_popup').slideDown();
            }
        };

        // Close Sales Enquiry Form
        SearchSec.closeSalesEnquiryForm = function () {
            $('#SalesEnquiryRequest_popup').slideUp();
            SearchSec.salesMessage = "";
        };

        /*  SearchSec.PrepareMail = function () {
  
  //            $('#Maping_popup').slideUp();
              $('#SalesEnquiryRequest_popup').slideDown();
          };*/

        //open Message form
        SearchSec.openSendMessageForm = function () {
            $('#sendMessage_popup').slideDown();
        };

        SearchSec.sendUserMessage = function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                $http({ method: 'post', url: GURL + 'ewtSaveMessage', data: { TokenNo: $rootScope._userInfo.Token, ToMasterID: SearchSec.mInfo.TID, MessageType: 1, Message: SearchSec.SendMessage, TaskDateTime: today } }).success(function (data) {
                    if (data.IsSuccessfull) {
                        $('#sendMessage_popup').slideUp();
                        SearchSec.SendMessage = "";
                        Notification.success({ message: 'Message send success', delay: MsgDelay });
                    }
                    else {
                        Notification.error({ message: 'Sorry..! Message not send ', delay: MsgDelay });
                    }
                });
            }
            else {
                //Redirect to Login page
                $('#SignIn_popup').slideDown();
            }
        };

        // Close Send Message Form
        SearchSec.closeSendMessageForm = function () {
            $('#sendMessage_popup').slideUp();
            SearchSec.SendMessage = "";
        };

        //open home delivery form
        SearchSec.openHomeDeliverForm = function () {
            $('#HomeDelivery_popup').slideDown();
        };

        //Send Home Delivery
        SearchSec.sendHomeDelivery = function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                $http({ method: 'post', url: GURL + 'ewtSaveMessage', data: { TokenNo: $rootScope._userInfo.Token, ToMasterID: SearchSec.mInfo.TID, MessageType: 2, Message: SearchSec.HomeDeliverMessage, TaskDateTime: today } }).success(function (data) {

                    if (data.IsSuccessfull) {
                        $('#HomeDelivery_popup').slideUp();
                        SearchSec.HomeDeliverMessage = "";
                        Notification.success({ message: 'Message send success', delay: MsgDelay });
                    }
                    else {
                        Notification.error({ message: 'Sorry..! Message not send ', delay: MsgDelay });
                    }
                });
            }
            else {
                //Redirect to Login page
                $('#SignIn_popup').slideDown();
            }
        };

        // Close HomeDeliver Form
        SearchSec.closeHomeDeliverForm = function () {
            SearchSec.HomeDeliverMessage = "";
            $('#HomeDelivery_popup').slideUp();
        };

        //open Reservation form
        SearchSec.openReservationForm = function () {
            $('#Reservation_popup').slideDown();
        };

        //Send Reservation
        SearchSec.sendReservation = function (messageType) {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                var dateTime = $filter('date')(SearchSec.ReservationDateTime, 'MM/dd/yyyy HH:mm:ss');  /*dd-MM-yyyy HH:mm a*/
                $http({ method: 'post', url: GURL + 'ewtSaveMessage', data: { TokenNo: $rootScope._userInfo.Token, ToMasterID: SearchSec.mInfo.TID, MessageType: messageType, Message: SearchSec.ReservationMessage, TaskDateTime: dateTime } }).success(function (data) {
                    if (data.IsSuccessfull) {
                        $('#Reservation_popup').slideUp();
                        SearchSec.ReservationMessage = "";
                        SearchSec.ReservationDateTime = "";
                        Notification.success({ message: 'Message send success', delay: MsgDelay });
                        document.getElementById("reservationMessage").className = "form-control fixTextArea emptyBox";
                        document.getElementById("expenseClaimDate").className = "datePickerWidth emptyBox";
                    }
                    else {
                        Notification.error({ message: 'Sorry..! Message not send ', delay: MsgDelay });
                    }
                });
            }
            else {
                //Redirect to Login page
                $('#SignIn_popup').slideDown();
            }
        };

        // Close Reservation Form
        SearchSec.closeReservationForm = function () {
            $('#Reservation_popup').slideUp();
            document.getElementById("reservationMessage").className = "form-control fixTextArea emptyBox";
            document.getElementById("expenseClaimDate").className = "datePickerWidth emptyBox";
            SearchSec.ReservationDateTime = "";
            SearchSec.ReservationDateTime = "";
        };

        //open Service Request form
        SearchSec.openServiceRequestForm = function () {
            $('#ServiceRequest_popup').slideDown();
        };

        //Send Service Request
        SearchSec.sendServiceRequest = function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                $http({ method: 'post', url: GURL + 'ewtSaveMessage', data: { TokenNo: $rootScope._userInfo.Token, ToMasterID: SearchSec.mInfo.TID, MessageType: 4, Message: SearchSec.ServiceRequestMessage, TaskDateTime: today } }).success(function (data) {

                    if (data.IsSuccessfull) {
                        $('#ServiceRequest_popup').slideUp();
                        SearchSec.ServiceRequestMessage = "";
                        Notification.success({ message: 'Message send success', delay: MsgDelay });

                    }
                    else {
                        Notification.error({ message: 'Sorry..! Message not send ', delay: MsgDelay });
                    }
                });
            }else {
                //Redirect to Login page
                $('#SignIn_popup').slideDown();
            }
        };

        // Close Service Request Form
        SearchSec.closeServiceRequestForm = function () {
            $('#ServiceRequest_popup').slideUp();

            SearchSec.ServiceRequestMessage = "";
        };

        //open CV form
        SearchSec.openCVForm = function() {
            $('#CV_popup').slideDown();
        };

        SearchSec.closeMappingPopup = function() {
            $('#Maping_popup').slideUp();
        };

        //Send CV Request
        SearchSec.sendCV = function () {

             if ($rootScope._userInfo.IsAuthenticate == true) {
                 $http({ method: 'post', url: GURL + 'ewtSaveMessage', data: { TokenNo: $rootScope._userInfo.Token, ToMasterID: SearchSec.mInfo.TID, MessageType: 4, Message: "", TaskDateTime: today } }).success(function (data) {
 
                     if (data.IsSuccessfull) {

                         SearchSec.ServiceRequestMessage = "";
                         //Notification.success({ message: 'CV send success', delay: MsgDelay });
 
                     }
                     else {
                         //Notification.error({ message: 'Sorry..! Message not send ', delay: MsgDelay });
                         
                     }
                 });
             }
             else {
                 //Redirect to Login page
                 $('#SignIn_popup').slideDown();
             }
        };

        //check for CV is uploaded by user or not
         SearchSec.checkForCVAvailability = function () {
            SearchSec.showCVSendButton = "";
             if ($rootScope._userInfo.IsAuthenticate == true)
             {
                 $http({ method: 'post', url: GURL + 'ewtCheckCV', data: { Token: $rootScope._userInfo.Token } }).success(function (data) {
                    if (data.IsSuccessfull)
                    {
                         SearchSec.sendCV();
                    }
                     else
                     {
                        $('#CV_popup').slideUp();
                        Notification.error({ message: 'Sorry..! CV is not uploaded... ', delay: MsgDelay });
                     }
                 });
             }
             else {
             //Redirect to Login page
             $('#SignIn_popup').slideDown();
             }
        };

        // Close CV Form
        SearchSec.closeCVForm = function () {
            $('#CV_popup').slideUp();
        };

        //close download form
        SearchSec.closeDownloadForm = function () {
            $('#download_popup').slideUp();
            SearchSec.IsShowForm = false;
        };

        //close download form
        SearchSec.SearchTypeKeyWord = function () {
            SearchSec.IsShowForm = false;
        };

        // Would write the value of the QueryString-variable called name to the console  
        var Qstr = getQueryStringValue("ID");

      //  console.log("QUERY STRING");
        if (Qstr != "") {
            SearchSec.Criteria.Keywords = Qstr;
            SearchSec.IsSearchPending = true;
            SearchSec.Criteria.SearchType = "1";
//          SearchSec.getSearch();
        }
    });

    ezeid.controller('ProfileController', function ($rootScope, $scope, $http, $q, $timeout, Notification ,$filter) {
        var profile = this;
        profile._info = {};
        profile.categories = [];
        profile.countries = [];
        profile.states = [];

    var MsgDelay = 2000;
    var isBusinessIcon = 0; // 1 = icon is for business Type
    if ($rootScope._userInfo) {
    }
    else {
        if (typeof (Storage) !== "undefined") {
            var encrypted = sessionStorage.getItem("_token");
            if (encrypted) {
                var decrypted = CryptoJS.AES.decrypt(encrypted, "EZEID");
                var Jsonstring = decrypted.toString(CryptoJS.enc.Utf8);
                if (Jsonstring) {
                    $rootScope._userInfo = JSON.parse(Jsonstring);
                }
            }
                else {
                    $rootScope._userInfo = {
                        IsAuthenticate: false,
                        Token: '',
                        FirstName: '',
                        Type:'',
                        Icon:''
                    };
                }
            } else {
                // Sorry! No Web Storage support..
                $rootScope._userInfo = {
                    IsAuthenticate: false,
                    Token: '',
                    FirstName: '',
                    Type:'',
                    Icon:''
                };
                alert('Sorry..! Browser does not support');
                window.location.href = "#/home";
            }
        }

        if($rootScope._userInfo.IsAuthenticate){
            $scope.heading = 'Update Profile';
        }
        else
        {
            $scope.heading = 'Create New Profile';
        }

        $http({ method: 'get', url: GURL + 'ewmGetCountry?LangID=1' }).success(function (data) {
            if ($rootScope._userInfo.Token == false) {
                var _obj = { CountryID: 0, CountryName: '--Country--', ISDCode: '####' };
                data.splice(0, 0, _obj);
                profile._info.CountryID = _obj.CountryID;
            }
            profile.countries = data;
         });

        $scope.$watch('_userInfo.IsAuthenticate', function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                GetUserDetails();
             }
            else {
                profile._info = {};
                profile._info.IDTypeID = 1;
                profile._info.NameTitleID = 1;
                profile._info.ParkingStatus = 1;
                profile._info.OpenStatus = 1;
            }
        });

        //Custom Methods
        function GetUserDetails() {
            //$rootScope.IsIdAvailable = true;
            $http({
                method: 'get',
                url: GURL + 'ewtGetUserDetails?Token=' + $rootScope._userInfo.Token
            }).success(function (data) {
                    profile.getStates(data[0].CountryID);
                    profile._info = data[0];
                    profile._info.StateID = data[0].StateID;
                    profile._info.CountryID = data[0].CountryID;
                    profile._info.ISDMobileNumber = data[0].ISDMobileNumber;
                    profile._info.ISDPhoneNumber = data[0].ISDPhoneNumber;
                    profile._info.Latitude = data[0].Latitude;
                    profile._info.Longitude = data[0].Longitude;

                    profile._info.SalesEnquiryButton =  profile._info.SalesEnquiryButton == 1 ? true : false;
                    profile._info.HomeDeliveryButton = profile._info.HomeDeliveryButton == 1 ? true : false;
                    profile._info.ReservationButton = profile._info.ReservationButton == 1 ? true : false;
                    profile._info.SupportButton = profile._info.SupportButton == 1 ? true : false;
                    profile._info.CVButton = profile._info.CVButton == 1 ? true : false;

                    profile._info.DOB =  new Date(data[0].DOB);

                   // profile._info.DOB = $filter('date')(new Date(data[0].DOB), 'dd-MMM-yyyy');
                    //console.log(profile._info.DOB);
                    initialize();
             });
        }

        var map;
        var mapOptions;
//        var myinfowindow = new google.maps.InfoWindow({
//            content: ''
//        });

        var marker;
        var markers = [];
        if ($rootScope._userInfo.IsAuthenticate == false) {
            initialize();
        }

        //Created by Abhishek for pop-up html(terms and condition)
        this.openTermsAndConditionForm=function(){
            $('#Terms_popup').css({'position':'fixed'});
            $('#Terms_popup > div').css({'margin-top':'0%'});
            $('#Terms_popup').slideDown();
        };
        this.closedTermsAndConditionForm=function(){
            $('#Terms_popup').slideUp();
        }
        this.CheckisIDAvailable = function () {
               $http({
                method: 'get',
                url: GURL + 'ewGetEZEID?EZEID=' + profile._info.EZEID
            }).success(function (data) {
                profile._info.IsIDAvailable = data.IsIdAvailable;
            });
        };

        //Maps
        function initialize() {

            var initialLocation;
            var currentLoc = new google.maps.LatLng(12.295810, 76.639381);

            map = new google.maps.Map(document.getElementById('map-canvas'), {
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                Zoom: 16
            });

            var ClocBtn = (document.getElementById('mapCloc'));
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(ClocBtn)

            if ($rootScope._userInfo.IsAuthenticate == true) {
                initialLocation = new google.maps.LatLng(profile._info.Latitude, profile._info.Longitude);
                PlaceCurrentLocationMarker(initialLocation);

            } else {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(FindCurrentLocation);
                }
            }

            //directionsDisplay.setMap(map);
            // Try W3C Geolocation (Preferred)
            if (navigator.geolocation) {
                browserSupportFlag = true;
                navigator.geolocation.getCurrentPosition(FindCurrentLocation, function () {
                    handleNoGeolocation();
                });
            }
            // Browser doesn't support Geolocation
            else {
                   handleNoGeolocation();
            }

            function handleNoGeolocation() {
                initialLocation = currentLoc;
                map.setCenter(initialLocation);
                PlaceCurrentLocationMarker(initialLocation);
                //PlaceMarker(initialLocation);
            }

            //// Create the search box and link it to the UI element.
            var input = (document.getElementById('txtSearch'));

            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

            var searchBox = new google.maps.places.SearchBox((input));

            // Listen for the event fired when the user selects an item from the
            // pick list. Retrieve the matching places for that item.
            google.maps.event.addListener(searchBox, 'places_changed', function () {
                 var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }
                for (var i = 0, marker; marker = markers[i]; i++) {
                    marker.setMap(null);
                }

                // For each place, get the icon, place name, and location.
                markers = [];
                var bounds = new google.maps.LatLngBounds();
                if (places.length > 0) {
                    var place = places[0];
                    $rootScope.CLoc.CLat = place.geometry.location.k;
                    $rootScope.CLoc.CLong = place.geometry.location.D;
                    var loc = new google.maps.LatLng($rootScope.CLoc.CLat, $rootScope.CLoc.CLong);
                    PlaceCurrentLocationMarker(loc);
                }
            });

            // Bias the SearchBox results towards places that are within the bounds of the
            // current map's viewport.
            google.maps.event.addListener(map, 'bounds_changed', function () {
                var bounds = map.getBounds();
                searchBox.setBounds(bounds);
            });

            google.maps.event.addListenerOnce(map, 'idle', function () {
              if(profile.IsSearchPending){
                    profile.getSearch();
                }
            });
         }
        function getReverseGeocodingData(lat, lng) {

            var latlng = new google.maps.LatLng(lat, lng);
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                if (status !== google.maps.GeocoderStatus.OK) {
                }
                if (status == google.maps.GeocoderStatus.OK) {
                    getAddressForLocation(results[0].address_components);
                }
            });
        }
        function getAddressForLocation(results) {

           /* if ($rootScope._userInfo.IsAuthenticate == false)
            {*/
                profile._info.CityTitle = "";
                profile._info.PostalCode = "";

                //console.log(results);
                angular.forEach(results, function (mapResultValue, index) {
                  /*  if ($rootScope._userInfo.IsAuthenticate == false)
                    {
                       // console.log(mapResultValue);
                        if (mapResultValue.types[0] == 'street_number') {
                            profile._info.AddressLine1 = mapResultValue.long_name;
                           // $scope.$apply();
                        }
                        if (mapResultValue.types[0] == 'route') {
                            if (profile._info.AddressLine1 != "") {
                                profile._info.AddressLine1 += "," + mapResultValue.long_name;
                               // $scope.$apply();
                            } else {
                                profile._info.AddressLine1 = mapResultValue.long_name;
                               // $scope.$apply();
                            }
                        }
                        if (mapResultValue.types[0] == 'neighborhood') {
                            if (profile._info.AddressLine1 != "") {
                                profile._info.AddressLine1 += "," + mapResultValue.long_name;
                               // $scope.$apply();
                            } else {
                                profile._info.AddressLine1 = mapResultValue.long_name;
                               // $scope.$apply();
                            }
                        }
                        if (mapResultValue.types[0] == 'sublocality_level_3') {
                            if (profile._info.AddressLine2 != "") {
                                profile._info.AddressLine2 += "," + mapResultValue.long_name;
                              //  $scope.$apply();
                            } else {
                                profile._info.AddressLine2 = mapResultValue.long_name;
                               // $scope.$apply();
                            }
                        }
                        if (mapResultValue.types[0] == 'sublocality_level_2') {
                            if (profile._info.AddressLine2 != "") {
                                profile._info.AddressLine2 += "," + mapResultValue.long_name;
                              //  $scope.$apply();
                            } else {
                                profile._info.AddressLine2 = mapResultValue.long_name;
                                //$scope.$apply();
                            }
                        }
                        if (mapResultValue.types[0] == 'sublocality_level_1') {
                            if (profile._info.AddressLine2 != "") {
                                profile._info.AddressLine2 += "," + mapResultValue.long_name;
                                //$scope.$apply();
                            } else {
                                profile._info.AddressLine2 = mapResultValue.long_name;
                               // $scope.$apply();
                            }
                        }
                    } */
                    if (mapResultValue.types[0] == 'locality') {
                        if (profile._info.CityTitle != "") {
                            profile._info.CityTitle += "," + mapResultValue.long_name;
                           // $scope.$apply();
                        } else {
                            profile._info.CityTitle = mapResultValue.long_name;
                           // $scope.$apply();
                        }
                    }

                    if (mapResultValue.types[0] == 'administrative_area_level_1') {
                        if (profile._info.State!= "") {
                            profile._info.State = mapResultValue.long_name;
                          //  $scope.$apply();
                        } else {
                            profile._info.State = mapResultValue.long_name;
                            //$scope.$apply();
                        }
                    }

                    if (mapResultValue.types[0] == 'postal_code') {
                        if (profile._info.PostalCode != "") {
                            profile._info.PostalCode += "," + mapResultValue.long_name;
                            //$scope.$apply();
                        } else {
                            profile._info.PostalCode = mapResultValue.long_name;
                          //  $scope.$apply();
                        }
                    }

                    if (mapResultValue.types[0] == 'country') {
                        if (profile._info.Country != "") {
                            profile._info.Country = mapResultValue.long_name;
                            //$scope.$apply();
                        } else {
                            profile._info.Country = mapResultValue.long_name;
                            //  $scope.$apply();
                        }
                    }

                    });


                 //   if( profile._info.CountryID == null || profile._info.CountryID == "")
                 //   {
                        var countryFileredString = $filter('filter')(profile.countries, profile._info.Country)
                        for (var key in countryFileredString)
                        {
                            if(profile._info.Country == countryFileredString[key].CountryName)
                            {
                                profile._info.CountryID = countryFileredString[key].CountryID;
                                profile._info.ISDMobileNumber = countryFileredString[key].ISDCode;
                                profile._info.ISDPhoneNumber = countryFileredString[key].ISDCode;
                            }
                        }
                  //  }
                updateState(profile._info.CountryID);
                getISDCode(profile._info.CountryID);
           // }
        }

        $scope.stateFilter = function()
        {
            var statesString = $filter('filter')(profile.states, profile._info.State);
            profile._info.StateID = statesString[0].StateID;
         }


        this.isMapInitialized = function () {
            if (profile.mapInit == false) {
                initialize();
                profile.mapInit = true;
            }
        };
        this.SearchOnMap = function (Query) {
            var request = {
                query: Query
            };
            service = new google.maps.places.PlacesService(map);
            service.textSearch(request, getMapSearchResults);
        };

        function getMapSearchResults(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                if (results.length > 0) {
                    var place = results[0];
                    profile._info.Latitude = place.geometry.location.k;
                    profile._info.Longitude = place.geometry.location.D;
                    var loc = new google.maps.LatLng(profile._info.Latitude, profile._info.Longitude);
                    PlaceCurrentLocationMarker(loc);
                    getReverseGeocodingData(profile._info.Latitude, profile._info.Longitude);
                }
            }
            else {
                Notification.error({ message: 'No Results found..!', delay: MsgDelay });
            }
        }
        function PlaceCurrentLocationMarker(location) {
            if (marker != undefined) {
                marker.setMap(null);
            }
            map.setCenter(location);
            marker = new google.maps.Marker({
                position: location,
                title: "Current Location",
                draggable: true,
                map: map,
                icon: 'images/you_are_here.png'
            });
            google.maps.event.addListener(marker, 'dragend', function (e) {
                profile._info.Latitude = marker.getPosition().k;
                profile._info.Longitude = marker.getPosition().D;
                getReverseGeocodingData(marker.getPosition().k, marker.getPosition().D);
               // myinfowindow.setContent('<h6>You are here</h6>');
             //   myinfowindow.open(map, marker);
            });
        }
        function FindCurrentLocation(position) {
           // if ($rootScope._userInfo.IsAuthenticate == false) {
                initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                PlaceCurrentLocationMarker(initialLocation);
                profile._info.Latitude = position.coords.latitude;
                profile._info.Longitude = position.coords.longitude;
                getReverseGeocodingData(profile._info.Latitude, profile._info.Longitude);
           // }
        };
        this.getMyLocation = function () {
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(FindCurrentLocation);
            }
        };


        $http({ method: 'get', url: GURL + 'ewmGetCategory?LangID=1' }).success(function (data) {
            var _obj = { CategoryID: 0, CategoryTitle: '--Category--' };
            data.splice(0, 0, _obj);
            profile.categories = data;
            profile._info.CategoryID = _obj.CategoryID;
        });


        $http({ method: 'get', url: GURL + 'ewmGetMTitle?LangID=1' }).success(function (data) {
            profile.Titles = data;
        });

        this.getStates = function (CountryID) {
            getISDCode(CountryID);
            updateState(CountryID);
        };
        this.getCities = function (StateID) {
            $http({ method: 'get', url: GURL + 'ewmGetCity?LangID=1&StateID=' + StateID }).success(function (data) {
                profile.cities = data;
            });
        };

        function updateState(CountryID)
        {
             $http({ method: 'get', url: GURL + 'ewmGetState?LangID=1&CountryID=' + CountryID }).success(function (data) {
                if ($rootScope._userInfo.Token == false) {
                    var _obj = { StateID: 0, StateName: '--State--' };
                    data.splice(0, 0, _obj);
                    profile._info.StateID = _obj.StateID;
                 }
              // console.log(data);
               profile.states = data;
               $scope.stateFilter();
            });
        }

        //To set country ISD Code from Country Id
        function getISDCode(CountryID)
        {
            var countryData = $filter('filter')(profile.countries, CountryID);
            for (var key in countryData)
            {
                if(profile._info.Country == countryData[key].CountryName)
                {
                    profile._info.ISDMobileNumber = countryData[key].ISDCode;
                    profile._info.ISDPhoneNumber = countryData[key].ISDCode;
                }
            }
         }
             //Save and Update Primary Registration
            this.savePrimaryRegistration = function (UserForm) {
                var notificationMessage = "";
              //  console.log(profile._info.EZEID.length);
                if(!profile._info.EZEID)
                {
                    notificationMessage += notificationMessage != "" ? ", EZE ID Required " : "EZE ID Required";
                   // Notification.error({ message: notificationMessage, delay: MsgDelay });
                    if(!profile._info.Password)
                    {
                        notificationMessage += notificationMessage != "" ? ", Password Required " : "Password Required";
                      //  Notification.error({ message: notificationMessage, delay: MsgDelay });
                    }
                    if(!profile._info.CPassword)
                    {
                        notificationMessage += notificationMessage != "" ? ", Re-Enter Password Required " : "Re-Enter Password Required";
                    }
                    if(profile._info.Password != profile._info.CPassword)
                    {
                        notificationMessage += notificationMessage != "" ? ", Password Mismatch " : "Password Mismatch";
                    }
                    if(!profile._info.FirstName)
                    {
                        notificationMessage += notificationMessage != "" ? ", First Name Required " : "First Name Required";
                    }
                    if(!profile._info.LastName)
                    {
                        notificationMessage += notificationMessage != "" ? ", Last Name Required " : "Last Name Required";
                    }
                    if(!profile._info.AddressLine1)
                    {
                        notificationMessage += notificationMessage != "" ? ", Address1 Required " : "Address1 Required";
                    }
                    if(!profile._info.AddressLine2)
                    {
                        notificationMessage += notificationMessage != "" ? ", AddressLine2 Required " : "AddressLine2 Required";
                    }



                    if(!profile._info.CountryID)
                    {
                        notificationMessage += notificationMessage != "" ? ", Country Required " : "Country Required";
                    }
                    if(!profile._info.StateID)
                    {
                        notificationMessage += notificationMessage != "" ? ", State Required " : "State Required";
                    }
                    if(!profile._info.CityTitle)
                    {
                        notificationMessage += notificationMessage != "" ? ", City Required " : "City Required";
                    }
                    if(!profile._info.PostalCode)
                    {
                        notificationMessage += notificationMessage != "" ? ", PostalCode Required " : "PostalCode Required";
                    }
                    if(!profile._info.MobileNumber)
                    {
                        notificationMessage += notificationMessage != "" ? ", Mobile Number Required " : "MobileNumber Required";
                    }
                    if(profile._info.IDTypeID  == '1')
                    {
                        if(!profile._info.DOB)
                        {
                            notificationMessage += notificationMessage != "" ? ", Date of birth Required " : "Date of birth Required";
                        }
                    }


                    /*Notification.error({ message: notificationMessage, delay: MsgDelay });*/
                    Notification.error({ message: notificationMessage, delay: 5000000 });
                }





                profile._info.SalesEnquiryButton =  profile._info.SalesEnquiryButton == true ? 1 : 0;
                profile._info.HomeDeliveryButton = profile._info.HomeDeliveryButton == true ? 1 : 0;
                profile._info.ReservationButton = profile._info.ReservationButton == true ? 1 : 0;
                profile._info.SupportButton = profile._info.SupportButton == true ? 1 : 0;
                profile._info.CVButton = profile._info.CVButton == true ? 1 : 0;

                if(profile._info.IDTypeID == 1)
                {
                    profile._info.Icon = $rootScope.smallImage;
                }
                else
                {
                    if(isBusinessIcon == 1)
                    {
                        profile._info.Icon = $rootScope.smallImage;
                    }
                }
            profile._info.LanguageID = 1;
            profile._info.IDTypeID = parseInt(profile._info.IDTypeID, 10);
            profile._info.Token = $rootScope._userInfo.Token;
            $http({
                method: "POST",
                url: GURL + 'ewSavePrimaryEZEData',
                data: JSON.stringify(profile._info),
                headers: { 'Content-Type': 'application/json' }
            }).success(function (data) {
                if (data.IsAuthenticate) {
                    $rootScope._userInfo = data;
                    if (typeof (Storage) !== "undefined") {
                        var encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), "EZEID");
                        sessionStorage.setItem("_token", encrypted);
                    } else {
                        alert('Sorry..! Browser does not support');
                        window.location.href = "#/home";
                    }
                    document.getElementById("EZEID").className = "form-control emptyBox";
                    document.getElementById("password").className = "form-control emptyBox";
                    document.getElementById("re-password").className = "form-control emptyBox";
                    document.getElementById("FName").className = "form-control emptyBox";
                    document.getElementById("LName").className = "form-control emptyBox";
                    document.getElementById("streeName").className = "form-control emptyBox";
                    document.getElementById("block").className = "form-control emptyBox";
                    document.getElementById("city").className = "form-control emptyBox";
                    document.getElementById("postalCode").className = "form-control emptyBox";
                    document.getElementById("mobile_phone").className = "form-control emptyBox";

                    getISDCode(profile._info.CountryID);
                    window.location.href = "#/home";
                    Notification.success({ message: "Saved... ", delay: MsgDelay });
                  } else {
                    if (UserForm.$valid) {
                        Notification.error({ message: "Registration failed", delay: MsgDelay });
                    }
                }
            });
        };

        //Upload Picture
        $scope.uploadImageForEditLocation = function (image) {
            profile._info.PictureFileName = image[0].name;
            fileToDataURL(image[0]).then(function (dataURL) {

                profile._info.Picture = dataURL;

                if (!profile._info.IDTypeID == 2) {

                    /* profile._info.Icon = "";
                     profile._info.IconFileName = "";*/
                } else {
                  //  profile._info.Icon = $rootScope.smallImage;
                    profile._info.IconFileName = image[0].name;
                }

                var enc=Base64.encode(dataURL);
                var dec=Base64.decode(enc);
               // window.open(dec,'_blank');
        });

         Notification.success({ message: "Image Saved..", delay: MsgDelay });
         };

        var fileToDataURL = function (file) {
            var deferred = $q.defer();
            var reader = new FileReader();
            reader.onload = function (e) {
                deferred.resolve(e.target.result);
            };
            reader.readAsDataURL(file);
            return deferred.promise;
        };


        //Upload Icon
        $scope.uploadIcon = function (image) {
            isBusinessIcon = 1;
           // profile._info.Icon = $rootScope.smallImage;
            profile._info.IconFileName = image[0].name;
            Notification.success({ message: "Image Saved..", delay: MsgDelay });
        };

        this.closeAddPhotoForEditLocation = function () {
            if ($rootScope._userInfo.IsAuthenticate == false) {
                profile._info.Picture = "";
                profile._info.PictureFileName = "";
            }
        };

        this.fileSizeConvert = function (bytes) {
            var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes == 0) return '0 Byte';
            var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        };

          profile.parkingStatus = [{ id: 0, label: "Parking Status" }, { id: 1, label: "Parking Available" }, { id: 2, label: "Public Parking" }, { id: 3, label: "Valet Parking" }, { id: 4, label: "No parking" }];

          profile.gender = [{ id: 0, label: "Male" }, { id: 1, label: "Female" }, { id: 2, label: "UnSpecified" }];
    });


    var Miliseconds = 300000;
    var RefreshTime = Miliseconds;

    ezeid.controller('NotifyController', function ($scope, $rootScope, $http, Notification, $filter, $interval) {
        var msgSen = this;
        var _pageValue = 1;
        var MsgDelay = 2000;
        msgSen.Status={id:"0,1",label:'New/Accepted'};
        msgSen.MessageType={id:"0,1,2,3,4,5,6",label:'All'};
        msgSen.msgs = [];
        var showPaging = "N";

        $interval(function() {
            msgSen.msgs = [];
            LoadNotifications(_pageValue);
        },RefreshTime);

        this.refreshNotificationGrid=function(){
            msgSen.msgs = [];
            LoadNotifications(_pageValue);
            RefreshTime = Miliseconds;
        };

        if ($rootScope._userInfo) {

        }
        else {
            if (typeof (Storage) !== "undefined") {
                var encrypted = sessionStorage.getItem("_token");
                if (encrypted) {
                    var decrypted = CryptoJS.AES.decrypt(encrypted, "EZEID");
                    var Jsonstring = decrypted.toString(CryptoJS.enc.Utf8);
                    if (Jsonstring) {
                        $rootScope._userInfo = JSON.parse(Jsonstring);
                    }
                }
                else {
                    $rootScope._userInfo = {
                        IsAuthenticate: false,
                        Token: '',
                        FirstName: '',
                        Type:'',
                        Icon:''
                    };
                }
            } else {
                // Sorry! No Web Storage support..
                $rootScope._userInfo = {
                    IsAuthenticate: false,
                    Token: '',
                    FirstName: '',
                    Type:'',
                    Icon:''
                };
                alert('Sorry..! Browser does not support');
                window.location.href = "#/";
            }
        }

        $scope.$watch('_userInfo.IsAuthenticate', function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                LoadNotifications(_pageValue);
            }
            else {
                window.location.href = "#/";
            }
        });

        function LoadNotifications(_pageValue){
            //_pageValue = _pageValue + 1;
            $http({ method: 'get', url: GURL + 'ewtGetMessages?TokenNo=' + $rootScope._userInfo.Token +'&Page='+_pageValue+'&Status='+msgSen.Status.id +'&MessageType='+msgSen.MessageType.id}).success(function (data) {

                //if (data.length > 0) {
                if (data != 'null') {
                    for (var i = 0; i < data.length; i++) {
                        msgSen.msgs.push(data[i]);
                        showPaging = data[0]['NextPage'];
                    }
                    if(showPaging == 'Y')
                    {
                        msgSen.showMoreButton = true;
                    }
                    else
                    {
                        msgSen.showMoreButton = false;
                    }
                }
                else
                {
                    msgSen.showMoreButton = false;
                    Notification.error({ message: "No Message found..!", delay: MsgDelay });
                }
            });
        }

        this.filterStatus=function(){
            msgSen.msgs = [];
            _pageValue = 1;
            LoadNotifications(_pageValue);
        };

        this.filterMessageType=function(){
            msgSen.msgs = [];
            _pageValue = 1;
            LoadNotifications(_pageValue);
        };

        msgSen.statusDrpDwn=[{id:"0,1",label:'New/Accepted'},{id:"0",label:'New'},{id:"1",label:'Accepted'},{id:"2",label:'Completed'},{id:"3",label:'Rejected'},{id:"0,1,2,3",label:'All'}];

        msgSen.typeDrpDwn=[{id:"0",label:'Normal Message'},{id:"1",label:'Sales Enquiry'},
            {id:"2",label:'Home Delivery'},{id:"3",label:'Reservation'},{id:"4",label:'Support Request'},{id:"5",label:'CV'},{id:"6",label:'Appointment'},{id:"0,1,2,3,4,5,6",label:'All'}];


        //More button click
        this.getNotifications = function (){
            _pageValue = _pageValue + 1;
            LoadNotifications(_pageValue);
        };

        //open Add Note Form
        this.openAddNoteForm = function (_item){
            //alert(_item.Notes);
            msgSen.item =_item;
            msgSen.Message =_item.Message;
            msgSen.NoteMessage =_item.Notes;
            $('#Notes_popup').slideDown();
        };

        //Send Add Note
        this.sendNote = function (_item) {
            if ($rootScope._userInfo.IsAuthenticate == true)
            {
                var sts = {
                    TokenNo: $rootScope._userInfo.Token,
                    Status: _item.Status,
                    TID: _item.TID,
                    Notes:msgSen.NoteMessage
                };
                $http({ method: 'post', url: GURL + 'ewtUpdateMessageStatus', data: sts }).success(function (data) {

                    if(data.IsUpdated==true){
                        _item.Notes=msgSen.NoteMessage;
                        $('#Notes_popup').slideUp();
                        Notification.success({ message: "Updated...", delay: MsgDelay });
                    }
                    else
                    {
                        Notification.error({ message: 'Sorry..! Not updated', delay: MsgDelay });
                    }
                });
            }
            else
            {
                //Redirect to Login page
                $('#SignIn_popup').slideDown();
            }
        };

        // Close Add Note
        this.closeAddNoteForm = function () {
            $('#Notes_popup').slideUp();
        };

        //btn Groups..Below code is for status button
        $scope.checkModel = {
            New: false,
            InProcess: false,
            Closed: false,
            Dropped:false
        };

        this.UpdateStatus = function (item, status) {
            var sts = {
                TokenNo: $rootScope._userInfo.Token,
                Status: status,
                TID: item.TID
            };
            $http({ method: 'post', url: GURL + 'ewtUpdateMessageStatus', data: sts }).success(function (data) {
                var _obj = data;
                if(data.IsUpdated==true){
                    item.Status=status;
                    Notification.success({ message: "Status updated...", delay: MsgDelay });
                }
                else
                {
                    Notification.error({ message: 'Sorry..! Status not updated', delay: MsgDelay });
                }
            });
        };
    });


    ezeid.controller('HistoryController', function ($scope, $rootScope, $http, Notification, $filter, $interval) {
        var msgSen = this;
        var _pageValue = 1;
        var MsgDelay = 2000;
        msgSen.msgs = [];
        var showPaging = "N";

        if ($rootScope._userInfo) {

        }
        else {
            if (typeof (Storage) !== "undefined") {
                var encrypted = sessionStorage.getItem("_token");
                if (encrypted) {
                    var decrypted = CryptoJS.AES.decrypt(encrypted, "EZEID");
                    var Jsonstring = decrypted.toString(CryptoJS.enc.Utf8);
                    if (Jsonstring) {
                        $rootScope._userInfo = JSON.parse(Jsonstring);
                    }
                }
                else {
                    $rootScope._userInfo = {
                        IsAuthenticate: false,
                        Token: '',
                        FirstName: '',
                        Type:'',
                        Icon:''
                    };
                }
            } else {
                // Sorry! No Web Storage support..
                $rootScope._userInfo = {
                    IsAuthenticate: false,
                    Token: '',
                    FirstName: '',
                    Type:'',
                    Icon:''
                };
                alert('Sorry..! Browser does not support');
                window.location.href = "index.html";
            }
        }

        $scope.$watch('_userInfo.IsAuthenticate', function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                LoadHistory(_pageValue);
            }
            else {
                window.location.href = "#/";
            }
        });

        function LoadHistory(_pageValue){

            $http({ method: 'get', url: GURL + 'ewtGetAccessHistory?TokenNo=' + $rootScope._userInfo.Token + '&Page='+_pageValue }).success(function (data) {

                if (data != 'null') {
                    for (var i = 0; i < data.length; i++) {
                        msgSen.msgs.push(data[i]);
                        showPaging = data[0]['NextPage'];
                    }
                    if(showPaging == 'Y')
                    {
                        msgSen.showMoreButton = true;
                    }
                    else
                    {
                        msgSen.showMoreButton = false;
                    }
                }
                else
                {
                    msgSen.showMoreButton = false;
                    Notification.error({ message: "No Message found..!", delay: MsgDelay });
                }
            });
        }

        //More button click
        this.getMoreHistory = function (){
            _pageValue = _pageValue + 1;
            LoadHistory(_pageValue);
        };

    });


   /* ezeid.controller('CVAttachController', function ($rootScope, $scope, $http, $q, $timeout, Notification, $window ) {

        //$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blo??b|coui):/);
        *//*$compileProvider.aHrefSanitizationWhitelist(/^\s*(|blob|):/); });*//*

        var CVAttachCtrl = this;
        CVAttachCtrl._CVInfo={};
        var MsgDelay = 2000;
        if ($rootScope._userInfo) {
        }
        else {
            if (typeof (Storage) !== "undefined") {
                var encrypted = sessionStorage.getItem("_token");
                if (encrypted) {
                    var decrypted = CryptoJS.AES.decrypt(encrypted, "EZEID");
                    var Jsonstring = decrypted.toString(CryptoJS.enc.Utf8);
                    if (Jsonstring) {
                        $rootScope._userInfo = JSON.parse(Jsonstring);
                    }
                }
                else {
                    $rootScope._userInfo = {
                        IsAuthenticate: false,
                        Token: '',
                        FirstName: '',
                        Type:'',
                        Icon:''
                    };
                }
            } else {
                // Sorry! No Web Storage support..
                $rootScope._userInfo = {
                    IsAuthenticate: false,
                    Token: '',
                    FirstName: '',
                    Type:'',
                    Icon:''
                };
                alert('Sorry..! Browser does not support');
                window.location.href = "index.html";
            }
        }

        $scope.$watch('_userInfo.IsAuthenticate', function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                getCVInfo();
            } else {
                window.location.href = "index.html";
            }
        });

        $http({ method: 'get', url: GURL + 'ewmGetFunctions?LangID=1'}).success(function (data) {
            var _obj = { FunctionID: 0, FunctionName: '--Select Function--' };
            data.splice(0, 0, _obj);
            CVAttachCtrl.Functions = data;
            console.log(data);
        });

        this.getRoleForFunction=function(_functionId){
            CVAttachCtrl.RoleTypes = "";
            *//*$http({ method: 'get', url: GURL + 'ewmGetRoleType?LangID=1&FunctionID='+CVAttachCtrl._CVInfo.FunctionID}).success(function (data) {*//*
            $http({ method: 'get', url: GURL + 'ewmGetRoleType?LangID=1&FunctionID='+_functionId}).success(function (data) {

                CVAttachCtrl.RoleTypes = data;
            });
        };

        $http({ method: 'get', url: GURL + 'ewmGetCountry?LangID=1' }).success(function (data) {
            var _obj = { CountryID: 0, CountryName: '--Country--', ISDCode: '' };
            data.splice(0, 0, _obj);
            CVAttachCtrl.countries = data;
        });
        this.getStates = function (CountryID) {
            $http({ method: 'get', url: GURL + 'ewmGetState?LangID=1&CountryID=' + CountryID }).success(function (data) {
                var _obj = { StateID: 0, StateName: '--State--' };
                CVAttachCtrl.states = data;
            });
        };
        this.getCities = function (StateID) {
            $http({ method: 'get', url: GURL + 'ewmGetCity?LangID=1&StateID=' + StateID }).success(function (data) {
                var _obj = { CityD: 0, CityName: '--City--' };
                CVAttachCtrl.cities = data;
            });
        };


        $scope.uploadFile = function (files) {
             console.log(files);
            CVAttachCtrl._CVInfo.CVDocFile = files[0].name;
            fileToDataURL(files[0]).then(function (dataURL) {
                CVAttachCtrl._CVInfo.CVDoc = dataURL;
                var enc=Base64.encode(dataURL);
                var dec=Base64.decode(enc);
                console.log(dec);
                window.open(dec,'_blank');
                console.log(CVAttachCtrl._CVInfo.CVDoc);
                //onDownload(dec);
            });
        };

        var fileToDataURL = function (file) {
            var deferred = $q.defer();
            var reader = new FileReader();
            reader.onload = function (e) {
                deferred.resolve(e.target.result);
            };
            reader.readAsDataURL(file);
            return deferred.promise;
        };

        *//*   function onDownload(dataToDownload) {
         document.location = 'data:Application/octet-stream,' +
         encodeURIComponent(dataToDownload);
         }*//*

        this.saveCVDocInfo=function(){
            CVAttachCtrl._CVInfo. TokenNo=$rootScope._userInfo.Token;
            CVAttachCtrl._CVInfo.Status=parseInt(CVAttachCtrl._CVInfo.Status);
            $http({
                method: "POST",
                url: GURL + 'ewtSaveCVInfo',
                data: JSON.stringify(CVAttachCtrl._CVInfo),
                headers: { 'Content-Type': 'application/json' }
            }).success(function (data) {
                if(data.IsSuccessfull) {
                    Notification.success({message: "Successfully Saved CV Info", delay: MsgDelay});
                    getCVInfo();
                }else{
                    Notification.error({message: "CV Info Not Saved !...", delay: MsgDelay});
                }
            });
        };

        this.download = function(){
            alert(CVAttachCtrl._CVInfo.CVDoc);
            window.location.assign(CVAttachCtrl._CVInfo.CVDoc);
            $window.open(CVAttachCtrl._CVInfo.CVDoc);
        }

        function getCVInfo(){
            $http({
                method: 'get',
                url: GURL + 'ewtGetCVInfo?TokenNo=' + $rootScope._userInfo.Token
            }).success(function (data) {
                console.log(data);
                CVAttachCtrl._CVInfo=data[0];
                //CVAttachCtrl.getRoleForFunction();
            });
        };

        this.closeCVDocInfo=function(cvForm){
            if($rootScope._userInfo.IsAuthenticate==false){
                cvForm.$setPristine(true);
            }

        };

        var content = 'file content';
        var blob = new Blob([ CVAttachCtrl._CVInfo.CVDoc ], { type : 'text/plain' });
        $scope.url = (window.URL || window.webkitURL).createObjectURL( blob );

    });
*/

    ezeid.controller('CVAttachController', function ($rootScope, $scope, $http, $q, $timeout, Notification, $window ) {

        //$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob|coui):/);
        /*$compileProvider.aHrefSanitizationWhitelist(/^\s*(|blob|):/); });*/

        var CVAttachCtrl = this;
        CVAttachCtrl._CVInfo={};
        var MsgDelay = 2000;
        if ($rootScope._userInfo) {
        }
        else {
            if (typeof (Storage) !== "undefined") {
                var encrypted = sessionStorage.getItem("_token");
                if (encrypted) {
                    var decrypted = CryptoJS.AES.decrypt(encrypted, "EZEID");
                    var Jsonstring = decrypted.toString(CryptoJS.enc.Utf8);
                    if (Jsonstring) {
                        $rootScope._userInfo = JSON.parse(Jsonstring);
                    }
                }
                else {
                    $rootScope._userInfo = {
                        IsAuthenticate: false,
                        Token: '',
                        FirstName: '',
                        Type:'',
                        Icon:''
                    };
                }
            } else {
                // Sorry! No Web Storage support..
                $rootScope._userInfo = {
                    IsAuthenticate: false,
                    Token: '',
                    FirstName: '',
                    Type:'',
                    Icon:''
                };
                alert('Sorry..! Browser does not support');
                window.location.href = "index.html";
            }
        }

        $scope.$watch('_userInfo.IsAuthenticate', function () {
            if ($rootScope._userInfo.IsAuthenticate == true) {
                getCVInfo();
            } else {
                window.location.href = "index.html";
            }
        });

        $http({ method: 'get', url: GURL + 'ewmGetFunctions?LangID=1'}).success(function (data) {
           // var _obj = { FunctionID:0, FunctionName: '--Select Function--' };
            //data.splice(0, 0, _obj);
            CVAttachCtrl.Functions = data;
            console.log(data);
        });

        this.getRoleForFunction=function(_functionId){
            console.log(_functionId);
            CVAttachCtrl.RoleTypes = "";
            /*$http({ method: 'get', url: GURL + 'ewmGetRoleType?LangID=1&FunctionID='+CVAttachCtrl._CVInfo.FunctionID}).success(function (data) {*/
            $http({ method: 'get', url: GURL + 'ewmGetRoles?LangID=1&FunctionID='+_functionId}).success(function (data) {

                CVAttachCtrl.RoleTypes = data;
            });
        };

        $http({ method: 'get', url: GURL + 'ewmGetCountry?LangID=1' }).success(function (data) {
            var _obj = { CountryID: 0, CountryName: '--Country--', ISDCode: '' };
            data.splice(0, 0, _obj);
            CVAttachCtrl.countries = data;
        });
        this.getStates = function (CountryID) {
            $http({ method: 'get', url: GURL + 'ewmGetState?LangID=1&CountryID=' + CountryID }).success(function (data) {
                var _obj = { StateID: 0, StateName: '--State--' };
                CVAttachCtrl.states = data;
            });
        };
        this.getCities = function (StateID) {
            $http({ method: 'get', url: GURL + 'ewmGetCity?LangID=1&StateID=' + StateID }).success(function (data) {
                var _obj = { CityD: 0, CityName: '--City--' };
                CVAttachCtrl.cities = data;
            });
        };


        //$scope.uploadFile = function (files) {
        //    console.log(files);
        //    CVAttachCtrl._CVInfo.CVDocFile = files[0].name;
        //    fileToDataURL(files[0]).then(function (dataURL) {
        //        CVAttachCtrl._CVInfo.CVDoc = dataURL;
        //        var enc=Base64.encode(dataURL);
        //        var dec=Base64.decode(enc);
        //        console.log(dec);
        //        //commented by abhishek
        //        //window.open(dec,'_blank');
        //        console.log(CVAttachCtrl._CVInfo.CVDoc);
        //        //onDownload(dec);
        //    });
        //};


        //Created by Abhishek
        $scope.uploadFile = function (files) {
            CVAttachCtrl._CVInfo.CVDocFile = files[0].name;
            for (var i = 0; i < files.length; i++) {
                var $file = files[i];
                var formData = new FormData();
                formData.append('file', $file);
                //formData.append('RefType', $scope.OptionSelected);
                formData.append('TokenNo', $rootScope._userInfo.Token);
                formData.append('RefType', 7);
                console.log(formData);


                $http({ method: 'POST', url: '/ewTUploadDoc/', data: formData,
                    headers: { 'Content-Type': undefined }, transformRequest: angular.identity })
                    .success(function (data, status, headers, config) {
                        console.log("uploaded");
                    }).
                    error(function(data, status, headers, config) {
                        console.log("upload ERROR");
                    });
            }
        };

        var fileToDataURL = function (file) {
            var deferred = $q.defer();
            var reader = new FileReader();
            reader.onload = function (e) {
                deferred.resolve(e.target.result);
            };
            reader.readAsDataURL(file);
            return deferred.promise;
        };

        /*   function onDownload(dataToDownload) {
         document.location = 'data:Application/octet-stream,' +
         encodeURIComponent(dataToDownload);
         }*/

        this.saveCVDocInfo=function(){
            CVAttachCtrl._CVInfo. TokenNo=$rootScope._userInfo.Token;
            CVAttachCtrl._CVInfo.Status=parseInt(CVAttachCtrl._CVInfo.Status);
            $http({
                method: "POST",
                url: GURL + 'ewtSaveCVInfo',
                data: JSON.stringify(CVAttachCtrl._CVInfo),
                headers: { 'Content-Type': 'application/json' }
            }).success(function (data) {
                    if(data.IsSuccessfull) {
                        Notification.success({message: "Successfully Saved CV Info", delay: MsgDelay});
                        getCVInfo();
                    }else{
                        Notification.error({message: "CV Info Not Saved !...", delay: MsgDelay});
                    }
                });
        };

        this.download = function(){
            alert(CVAttachCtrl._CVInfo.CVDoc);
            window.location.assign(CVAttachCtrl._CVInfo.CVDoc);
            $window.open(CVAttachCtrl._CVInfo.CVDoc);
        }

        function getCVInfo(){
            $http({
                method: 'get',
                url: GURL + 'ewtGetCVInfo?TokenNo=' + $rootScope._userInfo.Token
            }).success(function (data) {
                    console.log(data);
                    CVAttachCtrl._CVInfo=data[0];
                    //CVAttachCtrl.getRoleForFunction();
                });
        };

        this.closeCVDocInfo=function(cvForm){
            if($rootScope._userInfo.IsAuthenticate==false){
                cvForm.$setPristine(true);
            }

        };

        var content = 'file content';
        var blob = new Blob([ CVAttachCtrl._CVInfo.CVDoc ], { type : 'text/plain' });
        $scope.url = (window.URL || window.webkitURL).createObjectURL( blob );

    });

})();