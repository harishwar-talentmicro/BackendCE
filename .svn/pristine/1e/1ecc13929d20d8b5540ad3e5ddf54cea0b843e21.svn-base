/**
 * Created by mouli on 25/01/15.
 */


angular.module('ezeidApp').controller('LocationsController', function ($rootScope, $scope, $http, $timeout, Notification, $filter) {

    var SLocCtrl = this;

   // var initialLocation;
    var map;
    var mapOptions;
    var myinfowindow = new google.maps.InfoWindow({
        content: ''
    });


    var marker;
    var markers = [];
   /* if ($rootScope._userInfo.IsAuthenticate == false) {
        initialize();
    }*/

    var MsgDelay = 2000;

    SLocCtrl.IsShowForm = false;
    SLocCtrl.LocationsList = [];
    SLocCtrl._locInfo = {};
    SLocCtrl.mapInit = false;

    //initialize();

    if ($rootScope._userInfo) {
    }
    else {
        if (typeof (Storage) !== "undefined") {
            var encrypted = sessionStorage.getItem("_token");
            if (encrypted) {
                var decrypted = CryptoJS.AES.decrypt(encrypted, "EZEID");
                var Jsonstring = decrypted.toString(CryptoJS.enc.Utf8);
                if (Jsonstring) {
                    $rootScope._userInfo = JSON.parse(Jsonstring);
                }
            }
            else {
                $rootScope._userInfo = {
                    IsAuthenticate: false,
                    Token: '',
                    FirstName: '',
                    Type: '',
                    Icon: ''
                };
            }
        } else {
            // Sorry! No Web Storage support..
            $rootScope._userInfo = {
                IsAuthenticate: false,
                Token: '',
                FirstName: '',
                Type: '',
                Icon: ''
            };
            alert('Sorry..! Browser does not support');
            window.location.href = "/";
        }
    }

    $scope.$watch('_userInfo.IsAuthenticate', function () {
        if ($rootScope._userInfo.IsAuthenticate == true) {
            getSecondaryLoc();
        } else {

            window.location.href = "/";
        }
    });

    this.openNewLocationForm = function (secLocForm) {
        SLocCtrl._locInfo = {};
        SLocCtrl.IsShowForm = true;
        SLocCtrl.editSecLocEnb=false;

        initialize();

        //To set by default selected
         SLocCtrl._locInfo.ParkingStatus = 0;
         SLocCtrl._locInfo.OpenStatus = 1;


    };
    this.openEditSecLocForm = function (row) {
        SLocCtrl.editSecLocEnb = true;
        SLocCtrl._locInfo = row;
        SLocCtrl.IsShowForm = true;
        SLocCtrl._locInfo.TID = row.TID == null || row.TID == undefined ? row.LocationID : row.TID;
    };
    this.deleteSecLoc = function (row) {
        row.Token = $rootScope._userInfo.Token;
        row.TID = row.TID == null || row.TID == undefined ? row.LocationID : row.TID;
        $http({
            method: "POST",
            url: GURL + 'ewDeleteLocation',
            data: JSON.stringify({ TID: row.TID, Token: row.Token }),
            headers: { 'Content-Type': 'application/json' }
        }).success(function (data) {
            if (data.IsDeleted == true) {
                var index = SLocCtrl.LocationsList.indexOf(row);
                if (index !== -1) {
                    SLocCtrl.LocationsList.splice(index, 1);
                }
                Notification.success({ message: "Successfully deleted location" + row.LocTitle, delay: MsgDelay });
            } else {
                Notification.error({ message: "failed to delete location", delay: MsgDelay });
            }
        });
    };
    this.saveNewLoc = function (secLocForm) {

       /* if (secLocForm.MobileNumber.$dirty && secLocForm.LatAndLong.$dirty &&
            secLocForm.Add1.$dirty && secLocForm.Add2.$dirty && secLocForm.countries.$dirty
            && secLocForm.states.$dirty && secLocForm.cities.$dirty && secLocForm.postalCode.$dirty && secLocForm.MobileNumber.$dirty && secLocForm.email.$dirty) {
*/
            SLocCtrl._locInfo.Token = $rootScope._userInfo.Token;
            SLocCtrl._locInfo.TID = 0;
            SLocCtrl._locInfo.PIN = parseInt(SLocCtrl._locInfo.PIN);
            $http({
                method: "POST",

                url: GURL + 'ewmAddLocation',
                data: JSON.stringify(SLocCtrl._locInfo),
                headers: { 'Content-Type': 'application/json' }
            }).success(function (data) {
                if (data != 'null') {
                    SLocCtrl.LocationsList.push(data[0]);
                    SLocCtrl.IsShowForm = false;
                    Notification.success({ message: "Successfully added location" + data[0].LocTitle, delay: MsgDelay });
                } else {
                    Notification.error({ message: "Failed to add location", delay: MsgDelay });
                }
            });
        //}
    };
    this.updateNewLoc = function (secLocForm) {
        //        if(secLocForm.$valid){
        SLocCtrl._locInfo.Token = $rootScope._userInfo.Token;
        $http({
            method: "POST",
            url: GURL + 'ewmAddLocation',
            data: JSON.stringify(SLocCtrl._locInfo),
            headers: { 'Content-Type': 'application/json' }
        }).success(function (data) {
            if (data != 'null') {
                getSecondaryLoc();
                SLocCtrl.IsShowForm = false;
                Notification.success({ message: "Successfully updated location" + data[0].LocTitle, delay: MsgDelay });

            } else {
                Notification.error({ message: "Failed to update location", delay: MsgDelay });
            }
        });
        //        }
    };
    this.closeNewLoc = function (secLocForm) {
        if (!$rootScope._userInfo.IsAuthenticate) {
            secLocForm.$setPristine(true);
        }
        SLocCtrl.IsShowForm = false;
    };

    //get Locations Function
    function getSecondaryLoc() {
        $http({
            method: 'get',
            url: GURL + 'ewtGetSecondaryLoc?Token=' + $rootScope._userInfo.Token
        }).success(function (data) {
            if (data != 'null') {
                SLocCtrl.LocationsList = data;
            }
        });
    }

    //Maps
    function initialize() {
        var initialLocation;
        var currentLoc = new google.maps.LatLng(12.295810, 76.639381);

        map = new google.maps.Map(document.getElementById('map-canvas'), {
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            Zoom: 16
        });
        var ClocBtn = (document.getElementById('mapCloc'));
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(ClocBtn);

        if (JSON.stringify(SLocCtrl._locInfo) != '{}') {
            initialLocation = new google.maps.LatLng(SLocCtrl._locInfo.Latitude, SLocCtrl._locInfo.Longitude);
            PlaceCurrentLocationMarker(initialLocation);
        } else {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(FindCurrentLocation);
            }
        }

        //directionsDisplay.setMap(map);
        // Try W3C Geolocation (Preferred)
        if (navigator.geolocation) {
            browserSupportFlag = true;
            navigator.geolocation.getCurrentPosition(FindCurrentLocation, function () {
                handleNoGeolocation();
            });
        }
        // Browser doesn't support Geolocation
        else {
            handleNoGeolocation();
        }

        function handleNoGeolocation() {
            initialLocation = currentLoc;
            map.setCenter(initialLocation);
            PlaceCurrentLocationMarker(initialLocation);
            //PlaceMarker(initialLocation);
        }

        //// Create the search box and link it to the UI element.
        var input = (document.getElementById('txtSearch'));

        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        var searchBox = new google.maps.places.SearchBox((input));

        // Listen for the event fired when the user selects an item from the
        // pick list. Retrieve the matching places for that item.
        google.maps.event.addListener(searchBox, 'places_changed', function () {
            var places = searchBox.getPlaces();

            if (places.length == 0) {
                return;
            }
            for (var i = 0, marker; marker = markers[i]; i++) {
                marker.setMap(null);
            }

            // For each place, get the icon, place name, and location.
            markers = [];
            var bounds = new google.maps.LatLngBounds();
            if (places.length > 0) {
                var place = places[0];
                $rootScope.CLoc.CLat = place.geometry.location.k;
                $rootScope.CLoc.CLong = place.geometry.location.D;
                var loc = new google.maps.LatLng($rootScope.CLoc.CLat, $rootScope.CLoc.CLong);
                PlaceCurrentLocationMarker(loc);
            }
        });

        // Bias the SearchBox results towards places that are within the bounds of the
        // current map's viewport.
        google.maps.event.addListener(map, 'bounds_changed', function () {
            var bounds = map.getBounds();
            searchBox.setBounds(bounds);
        });

        google.maps.event.addListenerOnce(map, 'idle', function () {

            //   console.log("IDLE ONCE");
            if(SLocCtrl.IsSearchPending){
                SLocCtrl.getSearch();
            }
        });

    }
    function getReverseGeocodingData(lat, lng) {
        var latlng = new google.maps.LatLng(lat, lng);
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({ 'latLng': latlng }, function (results, status) {
            if (status !== google.maps.GeocoderStatus.OK) {
                //console.log(status);
            }
            if (status == google.maps.GeocoderStatus.OK) {
                getAddressForLocation(results[0].address_components);
            }
        });
    }
    function getAddressForLocation(results) {
        SLocCtrl._locInfo.AddressLine1 = "";
        SLocCtrl._locInfo.AddressLine2 = "";
        //SLocCtrl._locInfo.CountryID = "";
        //SLocCtrl._locInfo.StateID = "";
        SLocCtrl._locInfo.CityTitle = "";
        SLocCtrl._locInfo.PostalCode = "";
        angular.forEach(results, function (mapResultValue, index) {
            if (mapResultValue.types[0] == 'street_number') {
                SLocCtrl._locInfo.AddressLine1 = mapResultValue.long_name;
                $scope.$apply();
            }
            if (mapResultValue.types[0] == 'route') {
                if (SLocCtrl._locInfo.AddressLine1 != "") {
                    SLocCtrl._locInfo.AddressLine1 += "," + mapResultValue.long_name;
                    $scope.$apply();
                } else {
                    SLocCtrl._locInfo.AddressLine1 = mapResultValue.long_name;
                    $scope.$apply();
                }
            }
            if (mapResultValue.types[0] == 'neighborhood') {
                if (SLocCtrl._locInfo.AddressLine1 != "") {
                    SLocCtrl._locInfo.AddressLine1 += "," + mapResultValue.long_name;
                    $scope.$apply();
                } else {
                    SLocCtrl._locInfo.AddressLine1 = mapResultValue.long_name;
                    $scope.$apply();
                }
            }
            if (mapResultValue.types[0] == 'sublocality_level_3') {
                if (SLocCtrl._locInfo.AddressLine2 != "") {
                    SLocCtrl._locInfo.AddressLine2 += "," + mapResultValue.long_name;
                    $scope.$apply();
                } else {
                    SLocCtrl._locInfo.AddressLine2 = mapResultValue.long_name;
                    $scope.$apply();
                }
            }
            if (mapResultValue.types[0] == 'sublocality_level_2') {
                if (SLocCtrl._locInfo.AddressLine2 != "") {
                    SLocCtrl._locInfo.AddressLine2 += "," + mapResultValue.long_name;
                    $scope.$apply();
                } else {
                    SLocCtrl._locInfo.AddressLine2 = mapResultValue.long_name;
                    $scope.$apply();
                }
            }
            if (mapResultValue.types[0] == 'sublocality_level_1') {
                if (SLocCtrl._locInfo.AddressLine2 != "") {
                    SLocCtrl._locInfo.AddressLine2 += "," + mapResultValue.long_name;
                    $scope.$apply();
                } else {
                    SLocCtrl._locInfo.AddressLine2 = mapResultValue.long_name;
                    $scope.$apply();
                }
            }

            if (mapResultValue.types[0] == 'country') {
            }
            if (mapResultValue.types[0] == 'administrative_area_level_1') {
            }

            if (mapResultValue.types[0] == 'locality') {
                if (SLocCtrl._locInfo.CityTitle != "") {
                    SLocCtrl._locInfo.CityTitle += "," + mapResultValue.long_name;
                    $scope.$apply();
                } else {
                    SLocCtrl._locInfo.CityTitle = mapResultValue.long_name;
                    $scope.$apply();
                }
            }
            if (mapResultValue.types[0] == 'postal_code') {
                if (SLocCtrl._locInfo.PostalCode != "") {
                    SLocCtrl._locInfo.PostalCode += "," + mapResultValue.long_name;
                    $scope.$apply();
                } else {
                    SLocCtrl._locInfo.PostalCode = mapResultValue.long_name;
                    $scope.$apply();
                }
            }
            if (mapResultValue.types[0] == 'country') {

                SLocCtrl._locInfo.Country = mapResultValue.long_name;

                if( SLocCtrl._locInfo.CountryID == null || SLocCtrl._locInfo.CountryID == "")
                {
                    var countryFileredString = $filter('filter')(SLocCtrl.countries, SLocCtrl._locInfo.Country)

                    for (var key in countryFileredString)
                    {
                        if(SLocCtrl._locInfo.Country == countryFileredString[key].CountryName)
                        {
                            SLocCtrl._locInfo.CountryID = countryFileredString[key].CountryID;
                            //profile._info.ISDCode = countryFileredString[key].ISDCode;
                            // profile._info.ISDCode = "+91";

                            SLocCtrl._locInfo.ISDMobileNumber = countryFileredString[key].ISDCode;
                            SLocCtrl._locInfo.ISDPhoneNumber = countryFileredString[key].ISDCode;

                            updateState(countryFileredString[key].CountryID);
                        }
                    }
                }
                else
                {
                    updateState(SLocCtrl._locInfo.CountryID);
                    getISDCode(SLocCtrl._locInfo.CountryID);
                }
                $scope.$apply();
                /* } else {
                 $scope.$apply();
                 }*/
            }
        });
    }

    /*$("#select-address").on("shown", function () {
        alert("resize event");
        google.maps.event.trigger(map, "resize");
    });*/

    this.isMapInitialized = function () {

        //initialize();
        if (SLocCtrl.mapInit == false) {
            initialize();
            SLocCtrl.mapInit = true;
        }

       // $('#select-address').slideDown();
    };
    this.SearchOnMap = function (Query) {
        var request = {
            query: Query
        };
        service = new google.maps.places.PlacesService(map);
        service.textSearch(request, getMapSearchResults);
    };
    function getMapSearchResults(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
            if (results.length > 0) {
                var place = results[0];
                SLocCtrl._locInfo.Latitude = place.geometry.location.k;
                SLocCtrl._locInfo.Longitude = place.geometry.location.D;
                var loc = new google.maps.LatLng(SLocCtrl._locInfo.Latitude, SLocCtrl._locInfo.Longitude);
                PlaceCurrentLocationMarker(loc);
                getReverseGeocodingData(SLocCtrl._locInfo.Latitude, SLocCtrl._locInfo.Longitude);
            }
        }
        else {
            Notification.error({ message: 'No Results found..!', delay: MsgDelay });
        }
    }
    function PlaceCurrentLocationMarker(location) {
        if (marker != undefined) {
            marker.setMap(null);
        }
        map.setCenter(location);
        marker = new google.maps.Marker({
            position: location,
            title: "Current Location",
            draggable: true,
            map: map,
            icon: 'images/you_are_here.png'
        });
        google.maps.event.addListener(marker, 'dragend', function (e) {
            SLocCtrl._locInfo.Latitude = marker.getPosition().k;
            SLocCtrl._locInfo.Longitude = marker.getPosition().D;
            getReverseGeocodingData(marker.getPosition().k, marker.getPosition().D);
            //myinfowindow.setContent('<h6>You are here</h6>');
            myinfowindow.open(map, marker);
        });
    }
    function FindCurrentLocation(position) {
        /*initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        SLocCtrl._locInfo.Latitude = position.coords.latitude;
        SLocCtrl._locInfo.Longitude = position.coords.longitude;
        PlaceCurrentLocationMarker(initialLocation);
        getReverseGeocodingData(position.coords.latitude, position.coords.longitude);*/

        initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        PlaceCurrentLocationMarker(initialLocation);
        SLocCtrl._locInfo.Latitude = position.coords.latitude;
        SLocCtrl._locInfo.Longitude = position.coords.longitude;
        getReverseGeocodingData(SLocCtrl._locInfo.Latitude, SLocCtrl._locInfo.Longitude);
    };
    this.getMyLocation = function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(FindCurrentLocation);
        }
    };

    $http({ method: 'get', url: GURL + 'ewmGetCountry?LangID=1' }).success(function (data) {
        if ($rootScope._userInfo.Token == false) {
            var _obj = { CountryID: 0, CountryName: '--Country--', ISDCode: '' };
            data.splice(0, 0, _obj);
            SLocCtrl._locInfo.CountryID = _obj.CountryID;
        }
        SLocCtrl.countries = data;
    });
    /*this.getStates = function (CountryID) {
        $http({ method: 'get', url: GURL + 'ewmGetState?LangID=1&CountryID=' + CountryID }).success(function (data) {
            if ($rootScope._userInfo.Token == false) {
                var _obj = { StateID: 0, StateName: '--State--' };
                data.splice(0, 0, _obj);
                SLocCtrl._locInfo.StateID = _obj.StateID;
            }
            SLocCtrl.states = data;
        });
    };*/

    this.getStates = function (CountryID) {
        getISDCode(CountryID);
        updateState(CountryID);
    };

    function updateState(CountryID)
    {
        $http({ method: 'get', url: GURL + 'ewmGetState?LangID=1&CountryID=' + CountryID }).success(function (data) {
            if ($rootScope._userInfo.Token == false) {
                var _obj = { StateID: 0, StateName: '--State--' };
                data.splice(0, 0, _obj);

                SLocCtrl._locInfo.StateID = _obj.StateID;
            }
            SLocCtrl.states = data;
        });
    }

    //To set country ISD Code from Country Id
    function getISDCode(CountryID)
    {

        var countryData = $filter('filter')(SLocCtrl.countries, CountryID)
        // profile._info.ISDCode = countryData[0].ISDCode;
        SLocCtrl._locInfo.ISDMobileNumber = countryData[0].ISDCode;
        SLocCtrl._locInfo.ISDPhoneNumber = countryData[0].ISDCode;
    }

    this.getCities = function (StateID) {
        $http({ method: 'get', url: GURL + 'ewmGetCity?LangID=1&StateID=' + StateID }).success(function (data) {
            var _obj = { CityD: 0, CityName: '--City--' };
            SLocCtrl.cities = data;
        });
    };


    SLocCtrl.parkingStatus = [{ id: 0, label: "Select Parking Status" }, { id: 1, label: "Parking Available" },
        { id: 2, label: "Public Parking" }, { id: 3, label: "Valet Parking" }, { id: 4, label: "No parking" }];

    //imageUpload
    $scope.uploadImageForOtherLocation = function (image) {
        SLocCtrl._locInfo.PictureFileName = image[0].file.name;
       // SLocCtrl._locInfo.Picture = image.resized.dataURL;


        profile._info.PictureFileName = image[0].name;
        fileToDataURL(image[0]).then(function (dataURL) {

            profile._info.Picture = dataURL;

            if (!SLocCtrl._locInfo.IDTypeID == 2) {
                SLocCtrl._locInfo.Icon = "";
                SLocCtrl._locInfo.IconFileName = "";
            } else {
                SLocCtrl._locInfo.Icon = $rootScope.smallImage;
                SLocCtrl._locInfo.IconFileName = image.file.name;
            }
            var enc=Base64.encode(dataURL);
            var dec=Base64.decode(enc);
        });
        Notification.success({ message: "Successfully Saved Image:  " + image.file.name, delay: MsgDelay });
    };

        var fileToDataURL = function (file) {
            var deferred = $q.defer();
            var reader = new FileReader();
            reader.onload = function (e) {
                deferred.resolve(e.target.result);
            };
            reader.readAsDataURL(file);
            return deferred.promise;
        };
    /*this.closeAddPhotoForOtherLocation = function () {
        if ($rootScope._userInfo.IsAuthenticate == false) {
            SLocCtrl._locInfo.Picture = "";
            SLocCtrl._locInfo.PictureFileName = "";
        }
    }*/

   /* this.closeMappingPopup = function(){
      $('#select-address').slideUp();
    };*/

});
